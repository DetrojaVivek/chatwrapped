{% extends "base.html" %}

{% block title %}Upgrade to Premium - ChatWrapped{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <i class="bi bi-stars text-warning display-1"></i>
                    </div>
                    <h1 class="fw-bold mb-3">Premium Upgrade</h1>
                    <h2 class="text-success mb-4">Only ₹49 <small class="text-muted fs-6">(One-time payment)</small></h2>
                    
                    <div class="text-start bg-light p-4 rounded-3 mb-4">
                        <h5 class="fw-bold mb-3">Why Upgrade?</h5>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-check-lg text-success fs-4 me-2"></i>
                            <span>Unlock all <strong>Premium Templates</strong> instantly</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-check-lg text-success fs-4 me-2"></i>
                            <span>Remove <strong>Watermarks</strong> from all images</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-lg text-success fs-4 me-2"></i>
                            <span>Save <strong>History</strong> and re-download anytime</span>
                        </div>
                    </div>

                    <button id="pay-now-btn" class="btn btn-success btn-lg w-100 py-3 fw-bold shadow-sm">
                        <i class="bi bi-lock-fill me-2"></i> Pay ₹49 Securely
                    </button>
                    
                    <p class="text-muted mt-3 small">
                        <i class="bi bi-shield-check me-1"></i> Secured by Razorpay
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form to submit payment details verification -->
<form id="verify-form" action="{{ url_for('payment.verify_payment') }}" method="POST" style="display:none;">
    <input type="hidden" name="razorpay_payment_id" id="payment_id">
    <input type="hidden" name="razorpay_order_id" id="order_id">
    <input type="hidden" name="razorpay_signature" id="signature">
</form>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById('pay-now-btn').onclick = async function() {
    try {
        const btn = document.getElementById('pay-now-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        btn.disabled = true;

        // 1. Create Order on Backend
        const resp = await fetch('{{ url_for("payment.create_order") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}" // Handle CSRF if available, else ignored
            }
        });
        
        if (!resp.ok) {
            alert("Failed to create order. Please try again.");
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        const data = await resp.json();

        // 2. Open Razorpay Checkout
        const options = {
            key: data.key_id,
            amount: data.amount,
            currency: 'INR',
            name: 'ChatWrapped',
            description: 'Premium Upgrade - Lifetime Access',
            order_id: data.order_id,
            handler: function(response) {
                // 3. Verify Payment on Backend
                document.getElementById('payment_id').value = response.razorpay_payment_id;
                document.getElementById('order_id').value = response.razorpay_order_id;
                document.getElementById('signature').value = response.razorpay_signature;
                document.getElementById('verify-form').submit();
            },
            prefill: {
                name: data.name,
                email: data.email
            },
            theme: {
                color: '#198754' // Bootstrap Success Color
            },
            modal: {
                ondismiss: function() {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        
        var rzp = new Razorpay(options);
        rzp.open();

    } catch (error) {
        console.error('Error:', error);
        alert("An error occurred. Please try again.");
        document.getElementById('pay-now-btn').disabled = false;
        document.getElementById('pay-now-btn').innerHTML = '<i class="bi bi-lock-fill me-2"></i> Pay ₹49 Securely';
    }
};
</script>
{% endblock %}
